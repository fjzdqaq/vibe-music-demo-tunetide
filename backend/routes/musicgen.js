const express = require('express');
const { requireAuth } = require('../middleware/auth');
const { uploadToOSS } = require('../utils/ossUpload');
const Song = require('../models/Song');
const fetch = require('node-fetch');
const { generateMusicWithHuggingFace } = require('../services/aiMusicService');

const router = express.Router();

// AIæ­Œæ›²ç”Ÿæˆæ¥å£
router.post('/generate', requireAuth, async (req, res) => {
  try {
    const { prompt, duration = 15 } = req.body;
    
    if (!prompt || prompt.trim().length === 0) {
      return res.status(400).json({ success: false, message: 'è¯·æä¾›æ­Œæ›²æè¿°' });
    }

    console.log(`ğŸµ æ¥æ”¶åˆ°AIæ­Œæ›²ç”Ÿæˆè¯·æ±‚: "${prompt}", æ—¶é•¿: ${duration}s`);
    
    // 1. è°ƒç”¨AIéŸ³ä¹æœåŠ¡ç”ŸæˆéŸ³ä¹URL
    const musicUrl = await generateMusicWithHuggingFace(prompt, duration);

    // 2. ä»URLä¸‹è½½éŸ³é¢‘æ•°æ®
    console.log('â¬‡ï¸ æ­£åœ¨ä»Hugging Faceä¸‹è½½ç”Ÿæˆçš„éŸ³é¢‘...');
    const audioResponse = await fetch(musicUrl);
    if (!audioResponse.ok) {
      throw new Error(`æ— æ³•ä¸‹è½½ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶: ${audioResponse.statusText}`);
    }
    const audioBuffer = await audioResponse.buffer();
    console.log(`âœ… éŸ³é¢‘ä¸‹è½½æˆåŠŸ, å¤§å°: ${audioBuffer.length} bytes`);

    // 3. ä¸Šä¼ åˆ°OSS
    const fileName = `ai-music-${Date.now()}.wav`;
    console.log(`ğŸ“¤ æ­£åœ¨ä¸Šä¼  "${fileName}" åˆ°OSS...`);
    const ossUrl = await uploadToOSS(audioBuffer, fileName, 'audio/wav');
    console.log(`âœ… OSSä¸Šä¼ æˆåŠŸ: ${ossUrl}`);
    
    // 4. ä¿å­˜åˆ°æ•°æ®åº“
    const song = new Song({
      title: `AIç”Ÿæˆ: ${prompt.substring(0, 50)}`,
      artist: 'MusicGen AI',
      fileName: fileName,
      filePath: ossUrl,
      coverPath: '/default-cover.jpg',
      duration: duration,
      isPublic: false,
      uploadedBy: req.user.id,
      isAIGenerated: true,
      aiPrompt: prompt,
      withVocals: true, // MusicGené»˜è®¤ç”Ÿæˆå¸¦äººå£°çš„
    });
    
    await song.save();
    console.log(`ğŸ’¾ AIæ­Œæ›² "${song.title}" å·²ä¿å­˜åˆ°æ•°æ®åº“`);
    
    // 5. è¿”å›æˆåŠŸå“åº”
    res.json({
      success: true,
      message: 'AIæ­Œæ›²ç”ŸæˆæˆåŠŸï¼',
      song: song,
    });
    
  } catch (error) {
    console.error('âŒ AIæ­Œæ›²ç”Ÿæˆæµç¨‹å¤±è´¥:', error.message);
    res.status(500).json({
      success: false,
      message: error.message || 'AIæ­Œæ›²ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
    });
  }
});

// è·å–AIç”Ÿæˆå†å²
router.get('/history', requireAuth, async (req, res) => {
  try {
    const aiSongs = await Song.find({ 
      uploadedBy: req.user.userId,
      isAIGenerated: true 
    }).sort({ createdAt: -1 });

    res.json({
      success: true,
      songs: aiSongs
    });
  } catch (error) {
    console.error('âŒ è·å–AIç”Ÿæˆå†å²å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–AIç”Ÿæˆå†å²å¤±è´¥'
    });
  }
});

module.exports = router; 